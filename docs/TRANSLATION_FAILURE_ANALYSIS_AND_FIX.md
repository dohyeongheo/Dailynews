# 번역 실패 원인 분석 및 수정 요약

**수정 일자**: 2025-01-03
**문제**: 태국 뉴스 10개가 태국어로 저장되어 한국어 번역이 실패함

## 문제 분석

### 1. 현황
- 전체 뉴스: 659개
- 한국어 뉴스: 649개
- **번역 실패 뉴스: 10개** (모두 태국 뉴스, 태국어로 저장됨)

### 2. 번역 실패 원인

#### 2.1 프롬프트 문제
- **기존 프롬프트**: "태국 주요 뉴스(한국어 번역)만 수집하여..."
- **문제점**: Gemini API가 때때로 태국어 원문을 그대로 반환
- **원인**: 프롬프트가 명확하지 않아 API가 번역을 보장하지 않음

#### 2.2 번역 로직 문제
- **기존 로직**: `isKorean(content)` 체크 후 번역
- **문제점**: 태국 뉴스인 경우에도 한국어 체크 후에만 번역 시도
- **원인**: 태국 뉴스인 경우 무조건 번역해야 하는데 조건부로만 처리됨

#### 2.3 번역 실패 처리 문제
- **기존 처리**: 번역 실패 시 원본 그대로 저장
- **문제점**: 태국 뉴스 번역 실패 시 태국어가 그대로 DB에 저장됨
- **원인**: 태국 뉴스 번역 실패를 일반적인 경고로만 처리

## 수정 내용

### 1. 프롬프트 개선 (`lib/news-fetcher.ts`)

#### 1.1 태국 뉴스 전용 프롬프트
```typescript
// 변경 전
newsSourceInstruction = `${date}의 최신 태국 주요 뉴스(한국어 번역)만 수집하여 JSON 포맷으로 출력해주세요.`;

// 변경 후
newsSourceInstruction = `${date}의 최신 태국 주요 뉴스를 수집하여 **반드시 한국어로 번역하여** JSON 포맷으로 출력해주세요.
**중요: 제목과 본문 내용(content) 모두 반드시 한국어로 번역되어야 합니다. 태국어 원문을 그대로 출력하지 마세요.**`;
```

#### 1.2 모든 카테고리 수집 프롬프트
```typescript
// 변경 후
newsSourceInstruction = `${date}의 최신 태국 주요 뉴스(**반드시 한국어로 번역**), 한국의 태국 관련 뉴스, 한국 주요 뉴스를 수집하여...
**중요: 태국 뉴스의 경우 제목과 본문 내용(content) 모두 반드시 한국어로 번역되어야 합니다. 태국어 원문을 그대로 출력하지 마세요.**`;
```

#### 1.3 JSON 형식 설명 개선
```typescript
// 변경 전
"title": "뉴스 제목",
"content": "뉴스 본문 내용",
"content_translated": "번역된 내용 (태국 뉴스인 경우)",

// 변경 후
"title": "뉴스 제목 (태국 뉴스인 경우 한국어로 번역)",
"content": "뉴스 본문 내용 (태국 뉴스인 경우 한국어로 번역)",
// content_translated 필드 제거 (더 이상 사용하지 않음)
```

#### 1.4 중요 사항 섹션 개선
```typescript
// 추가
- **태국 뉴스(category가 "태국뉴스"인 경우)의 제목(title)과 본문 내용(content)은 반드시 한국어로 번역되어야 합니다. 태국어 원문을 그대로 출력하지 마세요.**
```

### 2. 번역 로직 개선 (`lib/news-fetcher.ts::translateNewsIfNeeded`)

#### 2.1 태국 뉴스 무조건 번역 보장
```typescript
// 변경 전
if (!isKorean(content)) {
  // 번역 시도
}

// 변경 후
const isThaiNews = newsItem.category === "태국뉴스";
if (isThaiNews || !isKorean(content)) {
  if (isThaiNews && !isKorean(content)) {
    log.warn("태국 뉴스가 한국어가 아닌 상태로 수집됨, 번역 시도", {
      category: newsItem.category,
      contentPreview: content.substring(0, 50),
    });
  }
  // 번역 시도
}
```

**효과**:
- 태국 뉴스인 경우 한국어 여부와 관계없이 무조건 번역 시도
- 태국어가 그대로 왔을 경우 경고 로그 기록

#### 2.2 번역 실패 시 에러 로그 강화
```typescript
// 변경 전
if (isTranslationFailed(content, translatedContent)) {
  log.warn("내용 번역 최종 실패", {...});
  translationFailed = true;
}

// 변경 후
if (isTranslationFailed(content, translatedContent)) {
  log.warn("내용 번역 최종 실패", {...});
  translationFailed = true;

  // 태국 뉴스인 경우 번역 실패는 치명적 오류이므로 강력한 경고 로그
  if (isThaiNews) {
    log.error("태국 뉴스 번역 실패 - 이 뉴스는 한국어가 아닌 상태로 저장됩니다", undefined, {
      category: newsItem.category,
      title: newsItem.title,
      contentPreview: content.substring(0, 100),
      totalAttempts: contentRetryCount + 1,
    });
  }
}
```

**효과**:
- 태국 뉴스 번역 실패 시 에러 레벨 로그로 기록하여 모니터링 용이
- 번역 실패한 태국 뉴스를 쉽게 추적 가능

## 기대 효과

### ✅ 프롬프트 개선
- Gemini API가 태국 뉴스를 한국어로 번역하여 반환할 가능성 증가
- 명확한 지시로 인한 번역 품질 향상

### ✅ 번역 로직 개선
- 태국 뉴스인 경우 무조건 번역 시도로 번역 누락 방지
- 태국어 원문이 와도 번역 로직이 작동하여 한국어로 변환

### ✅ 모니터링 개선
- 태국 뉴스 번역 실패 시 에러 로그로 기록하여 문제 추적 용이
- 번역 실패한 뉴스를 쉽게 식별 가능

## 향후 작업

1. **기존 번역 실패 뉴스 재번역**: 현재 DB에 저장된 10개의 태국어 뉴스는 관리자 페이지의 번역 재시도 기능을 통해 재번역 필요
2. **프로덕션 테스트**: 실제 뉴스 수집 시 태국 뉴스가 한국어로 번역되어 저장되는지 확인
3. **모니터링**: 태국 뉴스 번역 실패 에러 로그를 모니터링하여 추가 개선 사항 파악

## 참고사항

- 번역 실패한 뉴스는 여전히 DB에 저장됨 (원본 그대로)
- 번역 재시도 기능을 통해 수동으로 재번역 가능
- 향후 번역 성공률을 모니터링하여 프롬프트 추가 개선 가능

