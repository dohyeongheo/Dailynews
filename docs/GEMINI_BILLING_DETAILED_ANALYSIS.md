# Gemini API 상세 과금 분석

**분석 일시**: 2025-12-31
**프로젝트**: gen-lang-client-0408997230

---

## 1. 과금 발생 원리

### 토큰 기반 과금 시스템

Gemini API는 **토큰 사용량**에 따라 과금됩니다:

```
총 비용 = (입력 토큰 수 / 1,000,000) × 입력 토큰 가격 + (출력 토큰 수 / 1,000,000) × 출력 토큰 가격
```

### 토큰이란?

- **입력 토큰**: API에 전송하는 프롬프트의 토큰 수
- **출력 토큰**: API가 생성한 응답의 토큰 수
- **토큰**: 텍스트를 의미 있는 단위로 나눈 것 (단어, 문자 조합)

**예시**:

- "안녕하세요" = 약 2-3 토큰
- "Hello, how are you?" = 약 5-6 토큰
- 긴 뉴스 기사 (1,000자) = 약 250-300 토큰

---

## 2. 실제 사용 패턴 분석 (₩39,758 기준)

### 사용량 역산

**가정**: 평균적으로 Pro 모델과 Flash 모델을 혼합 사용

#### 시나리오 A: Pro 모델 중심 사용

- Pro 모델 평균 비용: 약 0.1원/1K 토큰
- ₩39,758 ÷ 0.1원 = 약 **397,580K 토큰** (약 397M 토큰)

#### 시나리오 B: Flash 모델 중심 사용

- Flash 모델 평균 비용: 약 0.05원/1K 토큰
- ₩39,758 ÷ 0.05원 = 약 **795,160K 토큰** (약 795M 토큰)

#### 시나리오 C: 혼합 사용 (현실적)

- 평균 비용: 약 0.075원/1K 토큰
- ₩39,758 ÷ 0.075원 = 약 **530,107K 토큰** (약 530M 토큰)

**추정 호출 횟수**:

- 평균 10,000 토큰/호출 가정
- 약 **53,000회 호출** 추정

---

## 3. 호출 패턴 분석 (Google AI Studio 데이터 기준)

### 일별 호출 추이

**12월 4일 ~ 12월 31일 (28일간)**:

1. **초기 단계** (12월 4-10일)

   - 높은 에러율 (404 Not Found)
   - 설정 및 테스트 단계
   - 추정 호출: 약 1,000-2,000회/일

2. **안정화 단계** (12월 11-24일)

   - 정상 운영 시작
   - 일일 뉴스 수집 정상화
   - 추정 호출: 약 200-500회/일

3. **피크 구간** (12월 25일)

   - 최대 호출: 약 500회
   - 가능한 원인: 추가 테스트 또는 대량 뉴스 수집

4. **현재** (12월 31일 ~ 1월 1일)
   - 안정적 운영
   - 추정 호출: 약 200-300회/일

### 에러 패턴 분석

**404 Not Found (초기 단계)**:

- 원인: API 엔드포인트 오류 또는 잘못된 요청
- 영향: 불필요한 비용 발생 (실패한 호출도 일부 과금 가능)
- 해결: 현재 해결됨

**429 TooManyRequests**:

- 원인: API 할당량 초과
- 영향: 재시도로 인한 추가 호출
- 해결: 재시도 로직 개선 및 할당량 관리

**503 ServiceUnavailable**:

- 원인: 서버 일시적 장애
- 영향: 재시도로 인한 추가 호출
- 해결: 자동 재시도 로직 적용

---

## 4. 작업 유형별 예상 비용 분포

### 뉴스 수집 (news_collection)

**특징**:

- 모델: Pro (기본)
- 복잡한 작업 (맥락 이해 필요)
- 호출 빈도: 낮음 (일 1회)
- 토큰 사용량: 높음 (평균 15,000-20,000 토큰/호출)

**예상 비용 비중**: 40-50%

### 번역 (translation)

**특징**:

- 모델: Flash (기본)
- 단순 작업
- 호출 빈도: 높음 (뉴스당 1회, 평균 20-30회/일)
- 토큰 사용량: 중간 (평균 1,000-2,000 토큰/호출)

**예상 비용 비중**: 30-40%

### 프롬프트 생성 (prompt_generation)

**특징**:

- 모델: Flash
- 단순 작업
- 호출 빈도: 높음 (뉴스당 1회, 평균 30회/일)
- 토큰 사용량: 낮음 (평균 500-1,000 토큰/호출)

**예상 비용 비중**: 10-20%

---

## 5. 비용 절감 효과 분석

### 현재 적용된 최적화

1. **모델 선택 최적화**

   - 번역/프롬프트: Flash 모델 사용
   - **절감 효과**: 약 60-70% (Pro 대비)

2. **Context Caching**

   - 동일 프롬프트 재사용
   - **절감 효과**: 약 10-20%

3. **에러 처리 개선**
   - 불필요한 재시도 최소화
   - **절감 효과**: 약 5-10%

### 추가 절감 가능성

1. **뉴스 수집 모델 전환** (Pro → Flash)

   - **절감**: 약 50-60%
   - **주의**: 품질 확인 필요

2. **번역 결과 캐싱**

   - 동일 텍스트 재번역 방지
   - **절감**: 약 20-30%

3. **배치 처리**
   - 여러 뉴스 한 번에 처리
   - **절감**: 약 10-15%

**총 예상 절감**: 현재 대비 **30-50%** 추가 절감 가능

---

## 6. 월별 예산 관리

### 현재 설정

- **월별 예산**: 40,000원
- **일별 알림 임계값**: 30,000원

### 예상 월간 사용량

**보수적 추정** (현재 패턴 유지):

- 일일 평균: 약 1,500원
- 월간: 약 **45,000원** (예산 초과)

**최적화 후 추정**:

- 일일 평균: 약 800원
- 월간: 약 **24,000원** (예산 내)

### 권장 조치

1. **즉시 조치**

   - 번역 결과 캐싱 구현
   - 에러율 모니터링 및 개선

2. **단기 조치** (1주일 내)

   - 뉴스 수집 모델 전환 검토 (품질 테스트 후)
   - 배치 처리 구현

3. **장기 조치** (1개월 내)
   - 사용 패턴 분석 및 추가 최적화
   - 예산 조정 검토 (필요시)

---

## 7. 실시간 모니터링 방법

### 관리자 대시보드

**접속**: `/admin` → "비용 모니터링" 탭

**확인 가능 정보**:

- 실시간 비용
- 일별/주별/월별 추이
- 모델별 사용량
- 작업 유형별 분석
- 비용 절감 제안

### API 엔드포인트

```bash
# 월별 비용 조회
GET /api/admin/cost?period=monthly

# 일별 비용 조회
GET /api/admin/cost?period=daily&startDate=2025-12-01&endDate=2025-12-31
```

### 유틸리티 스크립트

```bash
# 비용 조회
npm run tsx scripts/admin/check-gemini-cost.ts

# 사용량 분석
npm run tsx scripts/admin/analyze-gemini-usage.ts
```

---

## 8. 결론

### 현재 상태

- ✅ **시스템 구축**: 완료
- ✅ **사용량 추적**: 준비 완료 (다음 호출부터 시작)
- ⚠️ **비용 관리**: 주의 필요 (현재 패턴 유지 시 예산 초과 가능)

### 다음 단계

1. **즉시**: 다음 뉴스 수집 실행 후 사용량 로그 확인
2. **단기**: 비용 절감 방안 적용
3. **장기**: 사용 패턴 분석 및 예산 조정

---

**작성자**: AI Agent
**최종 업데이트**: 2025-12-31
