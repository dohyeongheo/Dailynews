# 할루시네이션 필터링 후 뉴스 수집 로직 분석

## 현재 로직 분석

### 1. 뉴스 수집 흐름

1. **Gemini API 호출**: 프롬프트를 통해 각 카테고리별 10개씩 총 30개의 뉴스를 요청
2. **데이터 검증 및 필터링**:
   - 필수 필드 검증
   - 날짜 검증 (과거/미래 날짜 필터링)
   - **할루시네이션 검사** (`isHallucinatedNews`)
3. **번역 처리**: 한국어가 아닌 뉴스 번역
4. **카테고리별 제한**: 각 카테고리별로 최대 10개씩만 선택

### 2. 문제점

#### 문제 1: 할루시네이션 필터링 후 추가 수집 없음

**현재 코드 위치**: `lib/news-fetcher.ts:788-792`

```typescript
log.info("데이터 검증 완료", {
  total: parsedData.news.length,
  valid: validNewsItems.length,
  hallucinationFiltered: hallucinationFilteredCount,
});

if (validNewsItems.length === 0) {
  throw new Error("유효한 뉴스 데이터가 없습니다. 모든 뉴스 항목이 필수 필드를 만족하지 않습니다.");
}
```

**문제**:
- 할루시네이션 뉴스가 필터링되어 `validNewsItems.length`가 30개 미만일 경우, 추가 수집을 하지 않음
- 예를 들어, 30개를 요청했지만 10개가 할루시네이션으로 필터링되어 20개만 남으면, 20개만 수집됨
- 카테고리별 10개씩 총 30개를 보장하지 못함

#### 문제 2: 카테고리별 개수 보장 불가

**현재 코드 위치**: `lib/news-fetcher.ts:863-911`

```typescript
// 카테고리별로 정확히 10개씩 제한
const CATEGORY_LIMIT = 10;
const categoryCounts: Record<NewsCategory, number> = {
  태국뉴스: 0,
  관련뉴스: 0,
  한국뉴스: 0,
};

const limitedNewsItems: NewsInput[] = [];

// 카테고리별로 제한
for (const newsItem of translatedNewsItems) {
  const category = newsItem.category;
  if (categoryCounts[category] < CATEGORY_LIMIT) {
    limitedNewsItems.push(newsItem);
    categoryCounts[category]++;
  }
}
```

**문제**:
- 이미 필터링된 `translatedNewsItems`에서만 선택하므로, 카테고리별로 10개가 부족한 경우 보충 불가
- 예를 들어, 태국뉴스가 할루시네이션 필터링 후 5개만 남으면, 5개만 수집됨 (10개 목표 미달)

### 3. 해결 방안

#### 방안 1: 재시도 로직 추가 (권장)

할루시네이션 필터링 후 카테고리별 개수가 부족한 경우, 추가로 Gemini API를 호출하여 부족한 개수만큼 더 수집

**구현 방식**:
1. 초기 수집: 30개 요청 (각 카테고리별 10개)
2. 할루시네이션 필터링 후 부족한 카테고리 확인
3. 부족한 카테고리별로 추가 수집 요청
   - 예: 태국뉴스 3개 부족 → 태국뉴스 3개 추가 요청
4. 최대 재시도 횟수 제한 (예: 3회)
5. 재시도 후에도 부족하면 경고 로그 출력

**장점**:
- 카테고리별 10개씩 총 30개를 보장
- API 호출 횟수를 최소화 (부족한 만큼만 추가 요청)

**단점**:
- API 호출 시간 증가
- 재시도 제한에 도달해도 부족할 수 있음

#### 방안 2: 초기 요청 개수 증가

할루시네이션 필터링을 고려하여 초기에 더 많은 뉴스를 요청 (예: 40-45개)

**장점**:
- 추가 API 호출 불필요
- 구현 간단

**단점**:
- 항상 추가 API 호출 비용 발생
- 여전히 보장 불가 (할루시네이션 비율이 높을 경우)

#### 방안 3: 하이브리드 방식 (권장)

1. 초기 요청: 35개 (여유분 포함)
2. 필터링 후 부족한 경우에만 재시도
3. 최대 재시도 2회

**장점**:
- 대부분의 경우 추가 호출 불필요
- 부족한 경우에만 추가 호출
- 구현 복잡도 적당

## 권장 사항

**방안 1 (재시도 로직 추가)** 또는 **방안 3 (하이브리드 방식)**을 권장합니다.

현재 분석 결과:
- ✅ 할루시네이션 필터링은 정상 작동
- ❌ 필터링 후 추가 수집 로직 없음
- ❌ 카테고리별 10개씩 총 30개 보장 불가
- ⚠️ 할루시네이션 비율이 높을 경우 목표 개수 미달 가능성 높음

